name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build Action
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: Build Action
      run: npm run build
      
    - name: Test Build
      run: npm run package-check
      
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/
        
  test:
    name: Test Action
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist/
        
    - name: Test Action with AMap
      uses: ./
      with:
        weather_provider: 'amap'
        amap_api_key: ${{ secrets.TEST_AMAP_API_KEY }}
        city: 'Beijing'
        smtp_host: 'smtp.example.com'
        smtp_port: '587'
        smtp_user: 'test@example.com'
        smtp_pass: 'test-password'
        recipient_emails: 'recipient@example.com'
      continue-on-error: true  # æµ‹è¯•å¯èƒ½å› ä¸ºæ— æ•ˆå‡­è¯è€Œå¤±è´¥
      
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build, test]
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist/
        
    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          ## ğŸŒ¤ï¸ Weather Notification Action Release
          
          ### âœ¨ Features
          - ğŸŒ æ”¯æŒé«˜å¾·åœ°å›¾å’ŒOpenWeatherMapåŒæ•°æ®æº
          - ğŸ™ï¸ æ™ºèƒ½åŸå¸‚è¯†åˆ«ï¼ˆä¸­è‹±æ–‡+åŸå¸‚ç¼–ç ï¼‰
          - ğŸ“§ ç²¾ç¾çš„HTMLé‚®ä»¶æ¨¡æ¿
          - ğŸ”§ çµæ´»çš„å‚æ•°é…ç½®
          
          ### ğŸ“¦ Installation
          ```yaml
          - uses: xun082/weather-notification-action@${{ github.ref }}
            with:
              weather_provider: 'amap'
              amap_api_key: ${{ secrets.AMAP_API_KEY }}
              # ... other parameters
          ```
          
          ### ğŸ“‹ Full Changelog
          See [CHANGELOG.md](CHANGELOG.md) for details.
        draft: false
        prerelease: false 